{"version":3,"file":"index.js","mappings":"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","sources":["webpack://PServ/webpack/universalModuleDefinition","webpack://PServ/webpack/bootstrap","webpack://PServ/webpack/runtime/define property getters","webpack://PServ/webpack/runtime/hasOwnProperty shorthand","webpack://PServ/webpack/runtime/make namespace object","webpack://PServ/./src/EventTarget.ts","webpack://PServ/./src/AbstractClient.ts","webpack://PServ/./src/IndexedObjectCollection.ts","webpack://PServ/./src/WebSocketStateTracker.ts","webpack://PServ/./src/WebSocketClient.ts","webpack://PServ/./src/WebApiClient.ts"],"sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"PServ\"] = factory();\n\telse\n\t\troot[\"PServ\"] = factory();\n})(self, () => {\nreturn ","// The require scope\nvar __webpack_require__ = {};\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","export type EventHandler<EventT> = (ev?: EventT) => void;\r\ntype HandlersMap<EventT> = Map<string, EventHandler<EventT>[]>;\r\n\r\nexport interface ObservableInterface<EventT = any> {\r\n    on(eventName: string, handler: EventHandler<EventT>): this;\r\n    once(eventName: string, handler: EventHandler<EventT>): this;\r\n}\r\n\r\nexport class EventTarget<EventT = any> implements ObservableInterface<EventT> {\r\n    protected events: HandlersMap<EventT> = new Map<string, EventHandler<EventT>[]>();\r\n    protected onceEvents: HandlersMap<EventT> = new Map<string, EventHandler<EventT>[]>();\r\n\r\n    public on(eventName: string, handler: EventHandler<EventT>): this {\r\n        this.addHandler(this.events, eventName, handler);\r\n        return this;\r\n    }\r\n\r\n    public once(eventName: string, handler: EventHandler<EventT>): this {\r\n        this.addHandler(this.onceEvents, eventName, handler);\r\n        return this;\r\n    }\r\n\r\n    public emit(eventName: string, event?: EventT): this {\r\n        this.callHandlers(this.events, eventName, event);\r\n        this.callHandlers(this.onceEvents, eventName, event);\r\n        this.onceEvents.delete(eventName);\r\n        return this;\r\n    }\r\n\r\n    private addHandler(map: HandlersMap<EventT>, eventName: string, handler: EventHandler<EventT>): void {\r\n        const handlers = map.get(eventName) ?? [];\r\n        handlers.push(handler);\r\n        map.set(eventName, handlers);\r\n    }\r\n\r\n    private callHandlers(map: HandlersMap<EventT>, eventName: string, event: EventT): void {\r\n        map.get(eventName)?.forEach(callback => callback(event));\r\n    }\r\n}","import {\r\n    Bye,\r\n    GetSession,\r\n    JoinSpace,\r\n    Ok,\r\n    Session,\r\n    SpaceJoined,\r\n    Error as ErrorType,\r\n    SpaceLeft,\r\n    SpaceMemberJoined,\r\n    SpaceMemberLeft,\r\n    SpaceMemberUpdate,\r\n    SpaceDeleted,\r\n    SpaceMembers,\r\n    SpaceRooms,\r\n    NewRole,\r\n    RoomDeleted,\r\n    RoomJoined,\r\n    RoomLeft,\r\n    RoomMemberLeft,\r\n    RoomMemberJoined,\r\n    RoomMembers,\r\n    NewRoom,\r\n    NewTopic,\r\n    TopicDeleted,\r\n    NewMessage,\r\n    GetUserPermissions,\r\n    SetUserPermissions,\r\n    GetComputedPermissions,\r\n    LeaveSpace,\r\n    CreateSpace,\r\n    DeleteSpace,\r\n    GetSpaceMembers,\r\n    GetSpaceRooms,\r\n    CreateRole,\r\n    DeleteRole,\r\n    AssignRole,\r\n    DeassignRole,\r\n    SetRolePermissions,\r\n    GetRolePermissions,\r\n    JoinRoom,\r\n    LeaveRoom,\r\n    CreateRoom,\r\n    DeleteRoom,\r\n    GetRoomMembers,\r\n    CreateTopic,\r\n    DeleteTopic,\r\n    CreateMessage, Envelope,\r\n} from \"pserv-ts-types\";\r\nimport {EventTarget} from \"./EventTarget\";\r\n\r\ntype ArrayOfPromiseResolvers = [(value: any) => void, (reason?: any) => void];\r\n\r\nexport abstract class AbstractClient extends EventTarget {\r\n    protected awaitingResponse: Map<string, ArrayOfPromiseResolvers> = new Map<string, ArrayOfPromiseResolvers>();\r\n    protected sentCounter: number = 0;\r\n\r\n    public abstract send<CommandType extends keyof CommandsMap>\r\n        (commandType: CommandType, commandData: CommandsMap[CommandType][0]): Promise<CommandResult<CommandsMap[CommandType][1]>>;\r\n\r\n    public on<EventName extends keyof EventsMap>\r\n        (eventName: EventName | string, handler: (event: EventsMap[EventName]) => void): this {\r\n        return super.on(eventName, handler);\r\n    }\r\n\r\n    public once<EventName extends keyof EventsMap>\r\n        (eventName: EventName, handler: (event: EventsMap[EventName]) => void): this {\r\n        return super.once(eventName, handler);\r\n    }\r\n\r\n    protected createEnvelope<CommandT>(type: string, data: CommandT): Envelope<CommandT> {\r\n        return {\r\n            type, data, ref: (++this.sentCounter).toString()\r\n        };\r\n    }\r\n\r\n    protected createPromiseFromCommandEnvelope\r\n        <CommandT extends keyof CommandsMap>(envelope: Envelope<CommandsMap[CommandT][0]>):\r\n        Promise<CommandResult<CommandsMap[CommandT][1]>> {\r\n        return new Promise((...args) =>\r\n            this.awaitingResponse.set(envelope.ref as string, args));\r\n    }\r\n\r\n    protected handleIncomingEnvelope(envelope: Envelope): void {\r\n        if (!this.awaitingResponse.has(envelope.ref)) {\r\n            return;\r\n        }\r\n        const isError = envelope.type === 'Error';\r\n        this.awaitingResponse.get(envelope.ref)[0]({\r\n            data: isError ? null : envelope.data,\r\n            error: isError ? envelope.data : null,\r\n        } as CommandResult<any>);\r\n        this.awaitingResponse.delete(envelope.ref);\r\n    }\r\n\r\n    protected handleEnvelopeSendError(envelope: Envelope, error: any): void {\r\n        if (!this.awaitingResponse.has(envelope.ref)) {\r\n            return;\r\n        }\r\n        this.awaitingResponse.get(envelope.ref)[0](error);\r\n        this.awaitingResponse.delete(envelope.ref);\r\n    }\r\n}\r\n\r\nexport type CommandResult<ResultT> = {data?: ResultT, error?: Error};\r\n\r\n/**\r\n * Map of incoming events.\r\n */\r\nexport type EventsMap = {\r\n    // General Events\r\n    Bye: Bye,\r\n    Ok: Ok,\r\n    Error: ErrorType,\r\n    Session: Session,\r\n    Permissions: Permissions,\r\n    // Space events\r\n    SpaceJoined: SpaceJoined,\r\n    SpaceLeft: SpaceLeft,\r\n    SpaceMemberJoined: SpaceMemberJoined,\r\n    SpaceMemberLeft: SpaceMemberLeft,\r\n    SpaceMemberUpdate: SpaceMemberUpdate,\r\n    SpaceDeleted: SpaceDeleted,\r\n    SpaceMembers: SpaceMembers,\r\n    SpaceRooms: SpaceRooms,\r\n    NewRole: NewRole,\r\n    RoleDeleted: RoomDeleted,\r\n    // Room events\r\n    RoomJoined: RoomJoined,\r\n    RoomLeft: RoomLeft,\r\n    RoomMemberJoined: RoomMemberJoined,\r\n    RoomMemberLeft: RoomMemberLeft,\r\n    RoomMembers: RoomMembers,\r\n    NewRoom: NewRoom,\r\n    RoomDeleted: RoomDeleted,\r\n    // Topic events\r\n    NewTopic: NewTopic,\r\n    TopicDeleted: TopicDeleted,\r\n    NewMessage: NewMessage,\r\n};\r\n\r\n/**\r\n * Map of commands and their corresponding events.\r\n */\r\nexport type CommandsMap = {\r\n    // General commands\r\n    GetSession: [GetSession, EventsMap['Session']],\r\n    SetUserPermissions: [SetUserPermissions, EventsMap['Permissions']],\r\n    GetUserPermissions: [GetUserPermissions, EventsMap['Permissions']],\r\n    GetComputedPermissions: [GetComputedPermissions, EventsMap['Permissions']],\r\n    // Space commands\r\n    JoinSpace: [JoinSpace, EventsMap['SpaceJoined']],\r\n    LeaveSpace: [LeaveSpace, EventsMap['SpaceLeft']],\r\n    CreateSpace: [CreateSpace, EventsMap['SpaceJoined']],\r\n    DeleteSpace: [DeleteSpace, EventsMap['SpaceDeleted']],\r\n    GetSpaceMembers: [GetSpaceMembers, EventsMap['SpaceMembers']],\r\n    GetSpaceRooms: [GetSpaceRooms, EventsMap['SpaceRooms']],\r\n    CreateRole: [CreateRole, EventsMap['NewRole']],\r\n    DeleteRole: [DeleteRole, EventsMap['RoleDeleted']],\r\n    AssignRole: [AssignRole, EventsMap['SpaceMemberUpdate']],\r\n    DeassignRole: [DeassignRole, EventsMap['SpaceMemberUpdate']],\r\n    SetRolePermissions: [SetRolePermissions, EventsMap['Permissions']],\r\n    GetRolePermissions: [GetRolePermissions, EventsMap['Permissions']],\r\n    // Room commands\r\n    JoinRoom: [JoinRoom, EventsMap['RoomJoined']],\r\n    LeaveRoom: [LeaveRoom, EventsMap['RoomLeft']],\r\n    CreateRoom: [CreateRoom, EventsMap['NewRoom']],\r\n    DeleteRoom: [DeleteRoom, EventsMap['RoomDeleted']],\r\n    GetRoomMembers: [GetRoomMembers, EventsMap['RoomMembers']],\r\n    // Topic commands\r\n    CreateTopic: [CreateTopic, EventsMap['NewTopic']],\r\n    DeleteTopic: [DeleteTopic, EventsMap['TopicDeleted']],\r\n    CreateMessage: [CreateMessage, EventsMap['NewMessage']],\r\n}","import {EventTarget, ObservableInterface} from \"./EventTarget\";\r\n\r\nexport class IndexedCollection<KeyT, ValueT> {\r\n    protected _items: Map<KeyT, ValueT> = new Map();\r\n\r\n    public constructor(items: [key: KeyT, value: ValueT][] = []) {\r\n        this.set(...items);\r\n    }\r\n\r\n    public get items(): Map<KeyT, ValueT> {\r\n        return this._items;\r\n    }\r\n\r\n    public get length(): number {\r\n        return this._items.size;\r\n    }\r\n\r\n    public set(...items: [KeyT, ValueT][]): void {\r\n        for (const item of items) {\r\n            this._items.set(item[0], item[1]);\r\n        }\r\n    }\r\n\r\n    public get(id: KeyT): ValueT | null {\r\n        return this.items.get(id);\r\n    }\r\n\r\n    public has(id: KeyT): boolean {\r\n        return this.items.has(id);\r\n    }\r\n\r\n    public delete(...ids: KeyT[]): void {\r\n        for (const id of ids) {\r\n            this.items.delete(id);\r\n        }\r\n    }\r\n\r\n    public deleteAll(): void {\r\n        this.items.clear();\r\n    }\r\n\r\n    public findBy(field: keyof ValueT, valueToFind: any, limit: number = null): IndexedCollection<KeyT, ValueT> {\r\n        const result = new IndexedCollection<KeyT, ValueT>();\r\n        let item;\r\n        while (!(item = this.items.entries().next().value).done) {\r\n            if (limit && result.length === limit) {\r\n                break;\r\n            }\r\n            if (item[1][field] === valueToFind) {\r\n                result.set(item);\r\n            }\r\n        }\r\n        return result;\r\n    }\r\n\r\n    public map<MapT = any>(callback: (item: ValueT, index: KeyT) => MapT): MapT[] {\r\n        return Array.from(this.items.entries()).map((entry) => callback(entry[1], entry[0]));\r\n    }\r\n}\r\n\r\nexport class IndexedObjectCollection<T> {\r\n    protected _items: IndexedCollection<string, T>;\r\n\r\n    public constructor(\r\n        public readonly id: keyof T | ((item: T) => any),\r\n        items: T[] = [],\r\n    ) {\r\n        this._items = new IndexedCollection<string, T>();\r\n        this.set(...items);\r\n    }\r\n\r\n    public get items(): T[] {\r\n        return Array.from(this._items.items.values());\r\n    }\r\n\r\n    public get length(): number {\r\n        return this._items.length;\r\n    }\r\n\r\n    public set(...items: T[]): void {\r\n        this._items.set(...(items.map(item => [this.getId(item), item] as [string, T])));\r\n    }\r\n\r\n    public get(id: any): T | null {\r\n        return this._items.get(id);\r\n    }\r\n\r\n    public getAt(index: number): T|null {\r\n        return this.items[index];\r\n    }\r\n\r\n    public has(id: any): boolean {\r\n        return this._items.has(id);\r\n    }\r\n\r\n    public delete(...ids: any[]): void {\r\n        this._items.delete(...ids);\r\n    }\r\n\r\n    public deleteAll(): void {\r\n        this._items.deleteAll();\r\n    }\r\n\r\n    public findBy(field: keyof T, valueToFind: any, limit: number = null): IndexedObjectCollection<T> {\r\n        const result = new IndexedObjectCollection<T>(this.id);\r\n        for (const value of this.items) {\r\n            if (limit && result.length === limit) {\r\n                break;\r\n            }\r\n            if (value[field] === valueToFind) {\r\n                result.set(value);\r\n            }\r\n        }\r\n        return result;\r\n    }\r\n\r\n    public map<MapT = any>(callback: (item: T, index: number, array: T[]) => MapT): MapT[] {\r\n        return this.items.map(callback);\r\n    }\r\n\r\n    protected getId(item: T): any {\r\n        return typeof this.id === 'function' ? this.id(item) : item[this.id];\r\n    }\r\n}\r\n\r\ninterface ObservableCollectionEvent<KeyT> {\r\n    setItems?: KeyT[],\r\n    deletedItems?: KeyT[],\r\n}\r\n\r\nexport class ObservableIndexedCollection<KeyT, ValueT> extends IndexedCollection<KeyT, ValueT> implements ObservableInterface {\r\n    protected eventTarget: EventTarget<ObservableCollectionEvent<KeyT>>;\r\n\r\n    public set(...items: [KeyT, ValueT][]) {\r\n        if (items.length) {\r\n            super.set(...items);\r\n            this.eventTarget.emit('change', {setItems: items.map(item => item[0])});\r\n        }\r\n    }\r\n\r\n    public delete(...ids: KeyT[]) {\r\n        if (ids.length) {\r\n            super.delete(...ids);\r\n            this.eventTarget.emit('change', {deletedItems: ids});\r\n        }\r\n    }\r\n\r\n    public deleteAll() {\r\n        if (this.length) {\r\n            const ids = this._items.keys();\r\n            super.deleteAll();\r\n            this.eventTarget.emit('change', {deletedItems: Array.from(ids)});\r\n        }\r\n    }\r\n\r\n    public on(eventName: 'change', handler: (ev?: ObservableCollectionEvent<KeyT>) => void): this {\r\n        this.eventTarget.on(eventName, handler);\r\n        return this;\r\n    }\r\n\r\n    public once(eventName: 'change', handler: (ev?: ObservableCollectionEvent<KeyT>) => void): this {\r\n        this.eventTarget.once(eventName, handler);\r\n        return this;\r\n    }\r\n}\r\n\r\nexport class ObservableIndexedObjectCollection<T> extends IndexedObjectCollection<T> implements ObservableInterface {\r\n    protected eventTarget: EventTarget<ObservableCollectionEvent<string>>;\r\n\r\n    public constructor(\r\n        public readonly id: keyof T | ((item: T) => string),\r\n        items: T[] = [],\r\n    ) {\r\n        super(id, items);\r\n        this.eventTarget = new EventTarget();\r\n    }\r\n\r\n    public set(...items: T[]) {\r\n        if (items.length) {\r\n            super.set(...items);\r\n            this.eventTarget.emit('change', {setItems: items.map(item => this.getId(item))});\r\n        }\r\n    }\r\n\r\n    public delete(...ids: string[]) {\r\n        if (ids.length) {\r\n            super.delete(...ids);\r\n            this.eventTarget.emit('change', {deletedItems: ids});\r\n        }\r\n    }\r\n\r\n    public deleteAll() {\r\n        if (this.length) {\r\n            const ids = this._items.items.keys();\r\n            super.deleteAll();\r\n            this.eventTarget.emit('change', {deletedItems: Array.from(ids)});\r\n        }\r\n    }\r\n\r\n    public on(eventName: 'change', handler: (ev?: ObservableCollectionEvent<string>) => void): this {\r\n        this.eventTarget.on(eventName, handler);\r\n        return this;\r\n    }\r\n\r\n    public once(eventName: 'change', handler: (ev?: ObservableCollectionEvent<string>) => void): this {\r\n        this.eventTarget.once(eventName, handler);\r\n        return this;\r\n    }\r\n}","import {WebSocketClient} from \"./WebSocketClient\";\r\nimport {IndexedCollection, ObservableIndexedObjectCollection} from \"./IndexedObjectCollection\";\r\nimport {\r\n    Message,\r\n    NewMessage,\r\n    NewRole,\r\n    NewRoom,\r\n    NewTopic, Role,\r\n    RoleDeleted,\r\n    Room,\r\n    RoomDeleted,\r\n    RoomJoined,\r\n    RoomLeft, RoomMember,\r\n    RoomMemberJoined,\r\n    RoomMemberLeft,\r\n    RoomMembers, RoomSummary,\r\n    Session,\r\n    Space,\r\n    SpaceDeleted,\r\n    SpaceJoined,\r\n    SpaceLeft, SpaceMember,\r\n    SpaceMemberJoined,\r\n    SpaceMemberLeft,\r\n    SpaceMembers,\r\n    SpaceMemberUpdate,\r\n    SpaceRooms, Topic,\r\n    TopicDeleted, User\r\n} from \"pserv-ts-types\";\r\n\r\ntype Deferred = {resolver: () => void, promise: Promise<void>};\r\n\r\nexport class WebSocketStateTracker {\r\n    private readonly joinedSpaces = new ObservableIndexedObjectCollection<Space>('id');\r\n    private readonly joinedRooms = new ObservableIndexedObjectCollection<Room>('id');\r\n    private readonly spacesRoles = new IndexedCollection<string, ObservableIndexedObjectCollection<Role>>();\r\n    private readonly roomsTopics = new IndexedCollection<string, ObservableIndexedObjectCollection<Topic>>();\r\n    // Temporary not lazy loaded; server must implement GetTopicMessages command.\r\n    private readonly topicsMessages = new IndexedCollection<string, ObservableIndexedObjectCollection<Message>>();\r\n\r\n    // lazy loaded collections\r\n    private readonly spacesRooms = new IndexedCollection<string, ObservableIndexedObjectCollection<RoomSummary>>();\r\n    private readonly spacesMembers = new IndexedCollection<string, ObservableIndexedObjectCollection<SpaceMember>>();\r\n    private readonly roomsMembers = new IndexedCollection<string, ObservableIndexedObjectCollection<RoomMember>>();\r\n    private readonly deferredGetters = new IndexedCollection<string, Deferred>();\r\n\r\n    private reconnecting: boolean = false;\r\n    private me: User = null;\r\n\r\n    public constructor(private readonly client: WebSocketClient) {\r\n        this.bind();\r\n    }\r\n\r\n    public async getMe(): Promise<User> {\r\n        await this.deferredGetterReadiness('session');\r\n        return this.me;\r\n    }\r\n\r\n    public async getJoinedSpaces(): Promise<ObservableIndexedObjectCollection<Space>> {\r\n        await this.deferredGetterReadiness('session');\r\n        return this.joinedSpaces;\r\n    }\r\n\r\n    public async getJoinedRooms(): Promise<ObservableIndexedObjectCollection<Room>> {\r\n        await this.deferredGetterReadiness('session');\r\n        return this.joinedRooms;\r\n    }\r\n\r\n    public async getSpaceRoles(spaceId: string): Promise<ObservableIndexedObjectCollection<Role> | null> {\r\n        await this.deferredGetterReadiness('session');\r\n        return this.spacesRoles.get(spaceId);\r\n    }\r\n\r\n    public async getRoomTopics(roomId: string): Promise<ObservableIndexedObjectCollection<Topic> | null> {\r\n        await this.deferredGetterReadiness('session');\r\n        return this.roomsTopics.get(roomId);\r\n    }\r\n\r\n    public async getTopicMessages(topicId: string): Promise<ObservableIndexedObjectCollection<Message> | null> {\r\n        return this.topicsMessages.get(topicId);\r\n    }\r\n\r\n    public async getSpaceRooms(spaceId: string): Promise<ObservableIndexedObjectCollection<RoomSummary> | null> {\r\n        const deferredGetterName = `spaces-rooms-${spaceId}`;\r\n        if (!this.spacesRooms.has(spaceId) && !this.deferredGetters.has(deferredGetterName)) {\r\n            this.createDeferredGetter(deferredGetterName);\r\n            this.client.send('GetSpaceRooms', {id: spaceId});\r\n        }\r\n        await this.deferredGetterReadiness(deferredGetterName);\r\n        return this.spacesRooms.get(spaceId);\r\n    }\r\n\r\n    public async getSpaceMembers(spaceId: string): Promise<ObservableIndexedObjectCollection<SpaceMember> | null> {\r\n        const deferredGetterName = `spaces-members-${spaceId}`;\r\n        if (!this.spacesMembers.has(spaceId) && !this.deferredGetters.has(deferredGetterName)) {\r\n            this.createDeferredGetter(deferredGetterName);\r\n            this.client.send('GetSpaceMembers', {id: spaceId});\r\n        }\r\n        await this.deferredGetterReadiness(deferredGetterName);\r\n        return this.spacesMembers.get(spaceId);\r\n    }\r\n\r\n    public async getRoomMembers(roomId: string): Promise<ObservableIndexedObjectCollection<RoomMember> | null> {\r\n        const deferredGetterName = `rooms-members-${roomId}`;\r\n        if (!this.roomsMembers.has(roomId) && !this.deferredGetters.has(deferredGetterName)) {\r\n            this.createDeferredGetter(deferredGetterName);\r\n            this.client.send('GetRoomMembers', {id: roomId});\r\n        }\r\n        await this.deferredGetterReadiness(deferredGetterName);\r\n        return this.roomsMembers.get(roomId);\r\n    }\r\n\r\n    private async deferredGetterReadiness(name: string): Promise<void> {\r\n        if (this.deferredGetters.has(name)) {\r\n            await this.deferredGetters.get(name)?.promise;\r\n        }\r\n    }\r\n\r\n    private bind(): void {\r\n        this.client.on(this.client.Event.disconnect, ev => this.handleDisconnect(ev as any as boolean));\r\n        this.client.on('NewMessage', ev => this.handleNewMessage(ev));\r\n        this.client.on('NewRole', ev => this.handleNewRole(ev));\r\n        this.client.on('NewRoom', ev => this.handleNewRoom(ev));\r\n        this.client.on('NewTopic', ev => this.handleNewTopic(ev));\r\n        this.client.on('RoleDeleted', ev => this.handleRoleDeleted(ev));\r\n        this.client.on('RoomDeleted', ev => this.handleRoomDeleted(ev));\r\n        this.client.on('RoomJoined', ev => this.handleRoomJoined(ev));\r\n        this.client.on('RoomLeft', ev => this.handleRoomLeft(ev));\r\n        this.client.on('RoomMemberJoined', ev => this.handleRoomMemberJoined(ev));\r\n        this.client.on('RoomMemberLeft', ev => this.handleRoomMemberLeft(ev));\r\n        this.client.on('RoomMembers', ev => this.handleRoomMembers(ev));\r\n        this.client.on('Session', ev => this.handleSession(ev));\r\n        this.client.on('SpaceDeleted', ev => this.handleSpaceDeleted(ev));\r\n        this.client.on('SpaceJoined', ev => this.handleSpaceJoined(ev));\r\n        this.client.on('SpaceLeft', ev => this.handleSpaceLeft(ev));\r\n        this.client.on('SpaceMemberJoined', ev => this.handleSpaceMemberJoined(ev));\r\n        this.client.on('SpaceMemberLeft', ev => this.handleSpaceMemberLeft(ev));\r\n        this.client.on('SpaceMembers', ev => this.handleSpaceMembers(ev));\r\n        this.client.on('SpaceRooms', ev => this.handleSpaceRooms(ev));\r\n        this.client.on('SpaceMemberUpdate', ev => this.handleSpaceMemberUpdate(ev));\r\n        this.client.on('TopicDeleted', ev => this.handleTopicDeleted(ev));\r\n    }\r\n\r\n    private createDeferredGetter(name: string): void {\r\n        if (this.deferredGetters.has(name)) {\r\n            return;\r\n        }\r\n        const deferred: Deferred = {promise: undefined, resolver: undefined};\r\n        deferred.promise = new Promise(resolve => deferred.resolver = resolve);\r\n        this.deferredGetters.set([name, deferred]);\r\n    }\r\n\r\n    private handleDisconnect(reconnect: boolean): void {\r\n        if (reconnect) {\r\n            this.reconnecting = true;\r\n            return;\r\n        }\r\n    }\r\n\r\n    private handleNewMessage(ev: NewMessage): void {\r\n        this.topicsMessages.get(ev.topicId).set(ev.message);\r\n    }\r\n\r\n    private handleNewRole(ev: NewRole): void {\r\n        const collection = this.spacesRoles.get(ev.spaceId);\r\n        collection.set(ev.role);\r\n        this.joinedSpaces.get(ev.spaceId).roles = collection.items;\r\n    }\r\n\r\n    private handleNewRoom(ev: NewRoom): void {\r\n        this.spacesRooms.get(ev.spaceId)?.set(ev.summary);\r\n    }\r\n\r\n    private handleNewTopic(ev: NewTopic): void {\r\n        const collection = this.roomsTopics.get(ev.roomId);\r\n        collection.set(ev.topic);\r\n        this.joinedRooms.get(ev.roomId).topics = collection.items;\r\n    }\r\n\r\n    private handleRoleDeleted(ev: RoleDeleted): void {\r\n        const collection = this.spacesRoles.get(ev.spaceId);\r\n        collection.delete(ev.id);\r\n        this.joinedSpaces.get(ev.spaceId).roles = collection.items;\r\n    }\r\n\r\n    private handleRoomDeleted(ev: RoomDeleted): void {\r\n        if (ev.spaceId) {\r\n            this.spacesRooms.get(ev.spaceId).delete(ev.id);\r\n        }\r\n        this.joinedRooms.delete(ev.id);\r\n        this.roomsMembers.delete(ev.id);\r\n        this.roomsTopics.delete(ev.id);\r\n    }\r\n\r\n    private handleRoomJoined(ev: RoomJoined): void {\r\n        this.addJoinedRooms(ev.room);\r\n    }\r\n\r\n    private addJoinedRooms(...rooms: Room[]): void {\r\n        this.roomsTopics.set(...rooms.map<[string, ObservableIndexedObjectCollection<Topic>]>(room => [\r\n            room.id,\r\n            new ObservableIndexedObjectCollection<Topic>('id', room.topics)\r\n        ]));\r\n        this.joinedRooms.set(...rooms);\r\n    }\r\n\r\n    private handleRoomLeft(ev: RoomLeft): void {\r\n        this.joinedRooms.delete(ev.id);\r\n        this.roomsMembers.delete(ev.id);\r\n        this.roomsTopics.delete(ev.id);\r\n    }\r\n\r\n    private handleRoomMemberJoined(ev: RoomMemberJoined): void {\r\n        if (this.roomsMembers.has(ev.roomId)) {\r\n            this.roomsMembers.get(ev.roomId).set(ev.member);\r\n        }\r\n    }\r\n\r\n    private handleRoomMemberLeft(ev: RoomMemberLeft): void {\r\n        if (this.roomsMembers.has(ev.roomId)) {\r\n            this.roomsMembers.get(ev.roomId).delete(ev.userId);\r\n        }\r\n    }\r\n\r\n    private handleRoomMembers(ev: RoomMembers): void {\r\n        if (!this.roomsMembers.has(ev.id)) {\r\n            this.roomsMembers.set([\r\n                ev.id,\r\n                new ObservableIndexedObjectCollection(\r\n                    member => member?.user.id ?? member.spaceMember.user.id,\r\n                    ev.members,\r\n                )\r\n            ]);\r\n            this.deferredGetters.get(`rooms-members-${ev.id}`)?.resolver();\r\n        }\r\n    }\r\n\r\n    private handleSession(ev: Session): void {\r\n        this.me = ev.user;\r\n\r\n        if (this.me && !this.reconnecting) {\r\n            return;\r\n        }\r\n\r\n        this.reconnecting = false;\r\n\r\n        this.joinedRooms.deleteAll();\r\n        this.roomsTopics.deleteAll();\r\n        this.roomsMembers.deleteAll();\r\n        this.joinedSpaces.deleteAll();\r\n        this.spacesRoles.deleteAll();\r\n        this.spacesRooms.deleteAll();\r\n        this.spacesMembers.deleteAll();\r\n\r\n        this.addJoinedRooms(...ev.state.rooms);\r\n        this.addJoinedSpaces(...ev.state.spaces);\r\n\r\n        this.deferredGetters.get('session')?.resolver();\r\n    }\r\n\r\n    private handleSpaceDeleted(ev: SpaceDeleted): void {\r\n        this.spacesRoles.delete(ev.id);\r\n        this.spacesMembers.delete(ev.id);\r\n        this.spacesRooms.delete(ev.id);\r\n        this.joinedSpaces.delete(ev.id);\r\n    }\r\n    \r\n    private handleSpaceJoined(ev: SpaceJoined): void {\r\n        this.addJoinedSpaces(ev.space);\r\n    }\r\n\r\n    private addJoinedSpaces(...spaces: Space[]): void {\r\n        this.spacesRoles.set(...(spaces.map(space => [\r\n            space.id,\r\n            new ObservableIndexedObjectCollection<Role>('id', space.roles)\r\n        ]) as [string, ObservableIndexedObjectCollection<Role>][]));\r\n        this.joinedSpaces.set(...spaces);\r\n    }\r\n\r\n    private handleSpaceLeft(ev: SpaceLeft): void {\r\n        this.spacesRoles.delete(ev.id);\r\n        this.spacesMembers.delete(ev.id);\r\n        this.spacesRooms.delete(ev.id);\r\n        this.joinedSpaces.delete(ev.id);\r\n    }\r\n\r\n    private handleSpaceMemberJoined(ev: SpaceMemberJoined): void {\r\n        if (this.spacesMembers.has(ev.spaceId)) {\r\n            this.spacesMembers.get(ev.spaceId).set(ev.member);\r\n        }\r\n    }\r\n\r\n    private handleSpaceMemberLeft(ev: SpaceMemberLeft): void {\r\n        if (this.spacesMembers.has(ev.spaceId)) {\r\n            this.spacesMembers.get(ev.spaceId).delete(ev.userId);\r\n        }\r\n    }\r\n\r\n    private handleSpaceMembers(ev: SpaceMembers): void {\r\n        if (!this.spacesMembers.has(ev.id)) {\r\n            this.spacesMembers.set([\r\n                ev.id,\r\n                new ObservableIndexedObjectCollection(member => member?.user.id, ev.members)\r\n            ]);\r\n            this.deferredGetters.get(`spaces-members-${ev.id}`)?.resolver();\r\n        }\r\n    }\r\n\r\n    private handleSpaceRooms(ev: SpaceRooms): void {\r\n        if (!this.spacesRooms.has(ev.id)) {\r\n            this.spacesRooms.set([ev.id, new ObservableIndexedObjectCollection('id', ev.summaries)]);\r\n            this.deferredGetters.get(`spaces-rooms-${ev.id}`)?.resolver();\r\n        }\r\n    }\r\n\r\n    private handleSpaceMemberUpdate(ev: SpaceMemberUpdate): void {\r\n        if (this.spacesMembers.has(ev.spaceId)) {\r\n            this.spacesMembers.get(ev.spaceId).set(ev.member);\r\n        }\r\n    }\r\n\r\n    private handleTopicDeleted(ev: TopicDeleted): void {\r\n        const collection = this.roomsTopics.get(ev.roomId);\r\n        collection.delete(ev.id);\r\n        this.joinedRooms.get(ev.roomId).topics = collection.items;\r\n    }\r\n}","import {ObservableInterface} from \"./EventTarget\";\r\nimport {AbstractClient, CommandResult, CommandsMap} from \"./AbstractClient\";\r\nimport {Envelope} from \"pserv-ts-types\";\r\nimport {WebSocketStateTracker} from \"./WebSocketStateTracker\";\r\n\r\nexport interface WebSocketClientOptions {\r\n    url: string;\r\n    token?: string;\r\n    temporaryNick?: string;\r\n    connectingTimeoutMs?: number;\r\n    awaitQueueSendDelayMs?: number;\r\n    stateTracking?: boolean;\r\n}\r\n\r\nenum WebSocketClientEvent {\r\n    connect = 'connect',\r\n    disconnect = 'disconnect',\r\n    message = 'message',\r\n    error = 'error',\r\n}\r\n\r\nexport class WebSocketClient extends AbstractClient implements ObservableInterface {\r\n    public readonly Event = WebSocketClientEvent;\r\n    public readonly state?: WebSocketStateTracker;\r\n\r\n    protected ws: WebSocket|null = null;\r\n    protected sendQueue: [commandType: keyof CommandsMap, commandData: any][] = [];\r\n    protected connectingTimeoutId: any;\r\n    protected authenticated: boolean;\r\n    protected authenticatedResolvers: [() => void, (error: Error) => void];\r\n\r\n    public constructor(private readonly options: WebSocketClientOptions) {\r\n        super();\r\n        if (!this.options.token && !this.options.temporaryNick) {\r\n            throw new Error('Token or temporary nick is required');\r\n        }\r\n        if (this.options.stateTracking ?? true) {\r\n            this.state = new WebSocketStateTracker(this);\r\n        }\r\n    }\r\n\r\n    public async connect(): Promise<void> {\r\n        const authString = this.options.token ? `token=${this.options.token}` : `nick=${this.options.temporaryNick}`;\r\n        this.ws = new WebSocket(`${this.options.url}?${authString}`);\r\n        this.ws.onclose = ev => this.onClose(ev);\r\n        this.ws.onmessage = ev => this.onMessage(ev);\r\n        this.connectingTimeoutId = setTimeout(\r\n            () => this.triggerConnectionTimeout(),\r\n            this.options.connectingTimeoutMs ?? 10000\r\n        );\r\n        this.authenticated = false;\r\n        return new Promise((...args) => this.authenticatedResolvers = args);\r\n    }\r\n\r\n    public disconnect(): void {\r\n        this.sendQueue = [];\r\n        this.ws?.close();\r\n        this.ws = null;\r\n    }\r\n\r\n    public async send<CommandType extends keyof CommandsMap>(commandType: CommandType, commandData: CommandsMap[CommandType][0]):\r\n       Promise<CommandResult<CommandsMap[CommandType][1]>> {\r\n        if (!this.ws || [this.ws.CLOSED, this.ws.CLOSING].includes(this.ws.readyState)) {\r\n            throw new Error('Cannot send; close or closing connection state');\r\n        }\r\n\r\n        if (this.ws.readyState === this.ws.CONNECTING || !this.authenticated) {\r\n            this.sendQueue.push([commandType, commandData] as any);\r\n            return;\r\n        }\r\n\r\n        if (this.ws.readyState !== this.ws.OPEN) {\r\n            throw new Error(`Invalid websocket state=${this.ws.readyState}`);\r\n        }\r\n\r\n        const envelope = this.createEnvelope<CommandsMap[CommandType][0]>(commandType, commandData);\r\n        this.ws.send(JSON.stringify(envelope));\r\n        return this.createPromiseFromCommandEnvelope<CommandType>(envelope);\r\n    }\r\n\r\n    private onMessage(event: MessageEvent): void {\r\n        const envelope: Envelope = JSON.parse(event.data);\r\n        // Login successfully\r\n        if (!this.authenticated) {\r\n            const isAuthenticated = envelope.type !== 'Error';\r\n            this.authenticated = isAuthenticated;\r\n            if (isAuthenticated) {\r\n                this.authenticatedResolvers[0]();\r\n                this.emit(this.Event.connect);\r\n                this.sendFromQueue();\r\n            } else {\r\n                this.authenticatedResolvers[1](envelope.data);\r\n            }\r\n        }\r\n        this.handleIncomingEnvelope(envelope);\r\n        this.emit(envelope.type, envelope);\r\n        this.emit(this.Event.message, envelope);\r\n    }\r\n\r\n    private onClose(event: CloseEvent): void {\r\n        clearTimeout(this.connectingTimeoutId);\r\n        const reconnect = event.code !== 1000; // Connection was closed because of error\r\n        if (reconnect) {\r\n            this.connect();\r\n        }\r\n        this.emit(this.Event.disconnect, reconnect);\r\n    }\r\n\r\n    private sendFromQueue(): void {\r\n        // Send awaiting data to server\r\n        let lastDelay = 0;\r\n        for (const dataIndex in this.sendQueue) {\r\n            const data = this.sendQueue[dataIndex];\r\n            setTimeout(() => this.send(...data), lastDelay);\r\n            lastDelay += this.options.awaitQueueSendDelayMs ?? 500;\r\n        }\r\n        this.sendQueue = [];\r\n        clearTimeout(this.connectingTimeoutId);\r\n    }\r\n\r\n    private triggerConnectionTimeout(): void {\r\n        this.disconnect();\r\n        this.emit(this.Event.error, new Error('Connection timeout'));\r\n    }\r\n}","import {AbstractClient, CommandResult, CommandsMap} from \"./AbstractClient\";\r\nimport {ObservableInterface} from \"./EventTarget\";\r\nimport {Envelope} from \"pserv-ts-types\";\r\n\r\nexport interface WebApiClientOptions {\r\n    url: string;\r\n    token?: string;\r\n    temporaryNick?: string;\r\n    attemptsToSend?: number;\r\n    attemptDelayMs?: number;\r\n}\r\n\r\nenum WebApiClientEvent {\r\n    message = 'message',\r\n    error = 'error',\r\n    destroy = 'destroy',\r\n}\r\n\r\nexport class WebApiClient extends AbstractClient implements ObservableInterface {\r\n    public readonly Event = WebApiClientEvent;\r\n\r\n    protected sendStack: {data: any, attempts: number, lastTimeoutId: any}[];\r\n\r\n    public constructor(private readonly options: WebApiClientOptions) {\r\n        super();\r\n        if (!this.options.token && !this.options.temporaryNick) {\r\n            throw new Error('Token or temporary nick is required');\r\n        }\r\n    }\r\n\r\n    public async send<CommandType extends keyof CommandsMap>(commandType: CommandType, commandData: CommandsMap[CommandType][0]):\r\n        Promise<CommandResult<CommandsMap[CommandType][1]>> {\r\n        const envelope = this.createEnvelope(commandType, commandData);\r\n        this.sendStack.push({data: envelope, attempts: 0, lastTimeoutId: null});\r\n        this.makeApiCall(this.sendStack.length - 1);\r\n        return this.createPromiseFromCommandEnvelope(envelope);\r\n    }\r\n\r\n    public destroy(): void {\r\n        // Cancel all awaiting requests\r\n        this.sendStack.forEach(item => {\r\n            if (item.lastTimeoutId) {\r\n                clearTimeout(item.lastTimeoutId);\r\n            }\r\n            this.awaitingResponse.delete(item.data.ref);\r\n        });\r\n        this.sendStack = [];\r\n        this.emit(this.Event.destroy, false);\r\n    }\r\n\r\n    protected async onMessage(reqId: number, response: Response): Promise<void> {\r\n        this.sendStack.splice(reqId, 1);\r\n        const envelope: Envelope = await response.json();\r\n        this.handleIncomingEnvelope(envelope);\r\n        this.emit(envelope.type, envelope);\r\n        this.emit(this.Event.message, envelope);\r\n    }\r\n\r\n    protected onError(reqId: number, body: string): void {\r\n        if (this.sendStack[reqId].attempts >= (this.options.attemptsToSend ?? 10)) {\r\n            this.sendStack.splice(reqId, 1);\r\n            this.handleEnvelopeSendError(this.sendStack[reqId].data, new Error(\r\n                `Cannot send ${body}; aborting after reaching the maximum connection errors`\r\n            ));\r\n            return;\r\n        }\r\n        this.sendStack[reqId].lastTimeoutId = setTimeout(\r\n            () => this.makeApiCall(reqId),\r\n            this.options.attemptDelayMs ?? 3000\r\n        );\r\n    }\r\n\r\n    protected makeApiCall(reqId: number): void {\r\n        this.sendStack[reqId].attempts++;\r\n        const bodyJson = JSON.stringify(this.sendStack[reqId].data);\r\n        const headers: any = {\r\n            'Content-Type': 'application/json',\r\n            Accept: 'application/json'\r\n        };\r\n\r\n        if (this.options.token) {\r\n            headers.Authorization = `Bearer ${this.options.token}`;\r\n        } else if (this.options.temporaryNick) {\r\n            headers.Authorization = `Temp ${this.options.temporaryNick}`;\r\n        }\r\n\r\n        fetch(this.options.url, {\r\n            headers,\r\n            body: bodyJson,\r\n            method: 'POST',\r\n        })\r\n            .then(response => this.onMessage(reqId, response))\r\n            .catch(() => this.onError(reqId, bodyJson));\r\n    }\r\n}"],"names":["root","factory","exports","module","define","amd","self","__webpack_require__","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","Symbol","toStringTag","value","EventTarget","Map","eventName","handler","this","addHandler","events","onceEvents","event","callHandlers","map","handlers","push","set","forEach","callback","AbstractClient","type","data","ref","sentCounter","toString","envelope","Promise","args","awaitingResponse","has","isError","error","IndexedCollection","items","_items","size","item","id","ids","clear","field","valueToFind","limit","result","entries","next","done","length","Array","from","entry","IndexedObjectCollection","values","getId","index","deleteAll","ObservableIndexedCollection","eventTarget","emit","setItems","deletedItems","keys","on","once","ObservableIndexedObjectCollection","i","WebSocketClientEvent","WebSocketStateTracker","client","bind","deferredGetterReadiness","me","joinedSpaces","joinedRooms","spaceId","spacesRoles","roomId","roomsTopics","topicId","topicsMessages","deferredGetterName","spacesRooms","deferredGetters","createDeferredGetter","send","spacesMembers","roomsMembers","name","promise","Event","disconnect","ev","handleDisconnect","handleNewMessage","handleNewRole","handleNewRoom","handleNewTopic","handleRoleDeleted","handleRoomDeleted","handleRoomJoined","handleRoomLeft","handleRoomMemberJoined","handleRoomMemberLeft","handleRoomMembers","handleSession","handleSpaceDeleted","handleSpaceJoined","handleSpaceLeft","handleSpaceMemberJoined","handleSpaceMemberLeft","handleSpaceMembers","handleSpaceRooms","handleSpaceMemberUpdate","handleTopicDeleted","deferred","undefined","resolver","resolve","reconnect","reconnecting","message","collection","role","roles","summary","topic","topics","addJoinedRooms","room","rooms","member","userId","user","spaceMember","members","state","addJoinedSpaces","spaces","space","summaries","WebApiClientEvent","WebSocketClient","options","token","temporaryNick","Error","stateTracking","authString","ws","WebSocket","url","onclose","onClose","onmessage","onMessage","connectingTimeoutId","setTimeout","triggerConnectionTimeout","connectingTimeoutMs","authenticated","authenticatedResolvers","sendQueue","close","commandType","commandData","CLOSED","CLOSING","includes","readyState","CONNECTING","OPEN","createEnvelope","JSON","stringify","createPromiseFromCommandEnvelope","parse","isAuthenticated","connect","sendFromQueue","handleIncomingEnvelope","clearTimeout","code","lastDelay","dataIndex","awaitQueueSendDelayMs","WebApiClient","sendStack","attempts","lastTimeoutId","makeApiCall","destroy","reqId","response","splice","json","body","attemptsToSend","handleEnvelopeSendError","attemptDelayMs","bodyJson","headers","Accept","Authorization","fetch","method","then","onError"],"sourceRoot":""}